## 地理位置功能使用指南

地理位置功能已成功集成到应用中，允许用户和AI发送地理位置消息。采用黑白简约风设计，参考QQ真实社交软件上发送定位的效果。

### 功能特性

1. **用户发送地理位置**
   - 点击工具栏中的地理位置按钮（📍图标）
   - 在弹窗中输入位置名称（必填）和详细地址（可选）
   - 点击"发送"按钮，地理位置消息将发送给AI
   - 支持 Ctrl+Enter 快速发送

2. **地理位置消息显示**
   - 用户发送的地理位置显示在右侧，采用深灰色（#e8e8e8）背景
   - AI发送的地理位置显示在左侧，采用浅灰色（#f5f5f5）背景
   - 每个地理位置气泡包含：
     - 📍 图标
     - 位置名称（主要信息）
     - 详细地址（如有）

3. **查看地理位置详情**
   - 点击对话中的地理位置气泡，可以展开显示完整的地理位置信息
   - 再次点击可以收起详情

4. **AI发送地理位置**
   - AI在回复中可以使用特殊标记发送地理位置
   - 标记格式：`【地理位置】位置名称|详细地址【/地理位置】`
   - 示例：`【地理位置】天安门广场|北京市东城区东长安街1号【/地理位置】`
   - AI会自动识别这个标记并转换为地理位置消息
   - 地址部分是可选的，如果不需要详细地址可以省略

5. **AI能识别地理位置信息**
   - 用户发送的地理位置，AI能够接收并在对话上下文中了解位置信息
   - AI可以根据接收到的位置信息进行相关回复
   - 地理位置内容被保存在消息中，便于后续参考

### 代码组件说明

#### 1. location-message.js
这是地理位置功能的核心模块，包含：
- **LocationMessageModule** - 主模块对象，采用IIFE（立即执行函数表达式）设计模式
- **init()** - 初始化地理位置功能
- **openLocationModal()** - 打开发送地理位置的弹窗
- **closeLocationModal()** - 关闭弹窗
- **createLocationModal()** - 创建弹窗DOM结构
- **sendLocationMessage()** - 发送地理位置消息
- **sendAILocationMessage()** - AI发送地理位置消息（可供app.js调用）
- **showLocationDetails()** - 显示地理位置详情
- **getLocationMessage()** - 获取地理位置消息数据

#### 2. app.js 中的集成
在 `renderChatMessages()` 函数中添加了地理位置消息的渲染逻辑：
- 识别 `msg.type === 'location'` 的消息
- 渲染带有📍图标、位置名称和地址的气泡
- 绑定点击事件以显示/隐藏详情
- 支持用户和AI的地理位置消息显示

在 `appendSingleAssistantMessage()` 函数中添加了地理位置识别：
- 从AI回复中提取 `【地理位置】...【/地理位置】` 标记
- 自动转换为地理位置消息对象
- 支持同一回复中包含地理位置和文本消息

#### 3. style.css 中的样式
添加了全面的地理位置功能样式：
- `.location-modal` - 弹窗容器
- `.location-modal-content` - 弹窗内容区域
- `.location-modal-header/body/footer` - 弹窗各部分
- `.location-bubble` - 对话中的地理位置气泡
- `.location-details` - 地理位置详情显示区域
- `.location-input` / `.location-address-input` - 输入框样式
- `.location-send-btn` / `.location-cancel-btn` - 按钮样式
- `.sent/.received` - 区分用户和AI发送的样式

### 使用示例

**用户发送地理位置：**
1. 打开与某个AI角色的对话
2. 点击工具栏中的地理位置按钮
3. 输入"上海迪士尼乐园"和"上海市浦东新区川沙路1200号"
4. 点击发送
5. 对话中会显示该地理位置气泡

**AI发送地理位置：**
在系统提示词或自定义回复中，可以这样指示AI：
```
当用户询问地点时，使用格式：【地理位置】位置名称|地址【/地理位置】来标记
例如：我建议你去【地理位置】颐和园|北京市海淀区新建宫门路19号【/地理位置】游玩
```

### 数据存储

地理位置消息数据结构：
```javascript
{
    id: 'msg_1234567890_abc123',
    type: 'location',
    content: '天安门广场 - 北京市东城区东长安街1号',
    locationName: '天安门广场',
    locationAddress: '北京市东城区东长安街1号',
    sender: 'sent',  // 用户发送为'sent'，AI发送为'received'
    timestamp: '2024-01-01T12:00:00.000Z'
}
```

### 样式特点

- **黑白简约风**：采用灰色系（#333, #666, #999, #e8e8e8, #f5f5f5等）
- **参考QQ设计**：地理位置气泡和显示效果参考QQ真实社交软件
- **响应式设计**：在移动设备上自动调整大小和布局
- **流畅动画**：弹窗打开/关闭有平滑的过渡动画
- **交互反馈**：hover和active状态有视觉反馈

### 技术细节

1. **模块化设计**
   - 地理位置功能独立在 `location-message.js` 中
   - 与 `voice-message.js` 保持相同的模块设计模式
   - 通过 `LocationMessageModule` 公开API供其他模块调用

2. **事件处理**
   - 弹窗遮罩点击关闭
   - 关闭按钮点击关闭
   - 发送按钮点击发送
   - 地理位置气泡点击显示详情

3. **数据流**
   - 用户输入 → 创建消息对象 → 存储到 AppState.messages → 触发 renderChatMessages() → 显示在对话页面
   - AI回复 → 提取地理位置标记 → 创建地理位置消息 → 存储到 AppState.messages → 显示在对话页面

4. **兼容性**
   - 与现有的语音条、表情包、转发等功能兼容
   - 在同一条AI回复中可以包含地理位置和其他内容

### 扩展建议

1. 可以添加地图集成，点击地理位置气泡时打开地图
2. 可以添加地理位置搜索功能，帮助用户选择位置
3. 可以添加地理位置分享功能，生成可分享的位置链接
4. 可以添加地理位置历史记录，快速选择常用位置

### 故障排查

**问题：地理位置弹窗不出现**
- 检查 `location-message.js` 是否正确引入到 `index.html`
- 检查浏览器控制台是否有错误信息
- 确保地理位置按钮的ID为 `btn-location`

**问题：AI发送的地理位置没有显示**
- 检查AI回复中的地理位置标记格式是否正确
- 标记格式必须为：`【地理位置】位置名称|地址【/地理位置】`
- 确保 `appendSingleAssistantMessage()` 中的正则表达式能正确匹配

**问题：地理位置消息显示为普通文本**
- 检查 `renderChatMessages()` 中的地理位置消息处理逻辑
- 确保 `msg.type === 'location'` 的条件被正确识别
